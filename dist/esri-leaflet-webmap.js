/* esri-leaflet-webmap - v0.3.0 - Tue Jun 28 2016 22:46:09 GMT+0900 (JST)
 * Copyright (c) 2016 Yusuke Nunokawa <nuno0825@gmail.com>
 * MIT */
!function(e,i){"object"==typeof exports&&"undefined"!=typeof module?i(exports,require("leaflet")):"function"==typeof define&&define.amd?define(["exports","leaflet"],i):i((e.L=e.L||{},e.L.esri=e.L.esri||{}),e.L)}(this,function(e,i){"use strict";function t(e,i){var t=/\{([^\]]*)\}/g,r="",o="";void 0!==e.title&&(r=e.title),r=r.replace(t,function(e){var r=t.exec(e);return i[r[1]]}),o='<div class="leaflet-popup-content-title"><h4>'+r+'</h4></div><div class="leaflet-popup-content-description" style="max-height:200px;overflow:auto;">';for(var a=0;a<e.fieldInfos.length;a++)e.fieldInfos[a].visible===!0&&(o+='<div style="font-weight:bold;color:#999;margin-top:5px;word-break:break-all;">'+e.fieldInfos[a].label+'</div><p style="margin-top:0;margin-bottom:5px;word-break:break-all;">'+i[e.fieldInfos[a].fieldName]+"</p>");return o+="</div>",e.mediaInfos.length>0,o}function r(e,i){var t=/\[([^\]]*)\]/g,r=i[0].labelExpression;return r=r.replace(t,function(i){var r=t.exec(i);return e[r[1]]})}function o(e,i,t){return a(e,i,t)}function a(e,o,a){if(console.log("generateEsriLayer: ",e.title,e),void 0!==e.featureCollection){console.log("create FeatureCollection");var l=e.featureCollection.layers[0].layerDefinition.drawingInfo.renderer,n=[],s=[];e.featureCollection.layers[0].featureSet.features.map(function(o){var a=c(l,o.attributes),u=i.Projection.SphericalMercator.unproject(i.point(o.geometry.x,o.geometry.y)),p=i.marker(u,{icon:a,opacity:e.opacity});if(void 0!==e.featureCollection.layers[0].popupInfo){var f=t(e.featureCollection.layers[0].popupInfo,o.attributes);p.bindPopup(f)}if(void 0!==e.featureCollection.layers[0].layerDefinition.drawingInfo.labelingInfo){var d=e.featureCollection.layers[0].layerDefinition.drawingInfo.labelingInfo,y=r(o.attributes,d),h=i.marker(u,{zIndexOffset:1,icon:i.divIcon({iconSize:null,className:"point-label",html:"<div>"+y+"</div>"})});s.push(h)}n.push(p)});var f=i.featureGroup(n);if(s.length>0){var d=i.featureGroup(s);f=i.layerGroup([f,d])}return o.push({type:"FC",title:e.title||"",layer:f}),f}if("ArcGISFeatureLayer"===e.layerType&&void 0!==e.layerDefinition){if(void 0!==e.layerDefinition.drawingInfo){if("heatmap"===e.layerDefinition.drawingInfo.renderer.type){console.log("create HeatmapLayer");var y={};e.layerDefinition.drawingInfo.renderer.colorStops.map(function(e){y[(Math.round(100*e.ratio)/100+6)/7]="rgb("+e.color[0]+","+e.color[1]+","+e.color[2]+")"});var f=i.esri.Heat.heatmapFeatureLayer({url:e.url,minOpacity:.5,max:e.layerDefinition.drawingInfo.renderer.maxPixelIntensity,blur:e.layerDefinition.drawingInfo.renderer.blurRadius,radius:1.3*e.layerDefinition.drawingInfo.renderer.blurRadius,gradient:y});return o.push({type:"HL",title:e.title||"",layer:f}),f}console.log("create ArcGISFeatureLayer (with layerDefinition.drawingInfo)");var l=e.layerDefinition.drawingInfo.renderer,h="1=1";void 0!==e.layerDefinition.definitionExpression&&(h=e.layerDefinition.definitionExpression);var s=[],d=i.featureGroup(s),f=i.esri.featureLayer({url:e.url,where:h,ignoreRenderer:!0,pointToLayer:function(t,r){var o=c(l,t.properties),a=i.marker(r,{icon:o,opacity:e.opacity});return a},style:function(e){var i;return"LineString"!==e.geometry.type&&"MultiLineString"!==e.geometry.type&&"Polygon"!==e.geometry.type&&"MultiPolygon"!==e.geometry.type||(i=u(l,e.properties)),i},onEachFeature:function(o,a){if(void 0!==e.popupInfo){var l=t(e.popupInfo,o.properties);a.bindPopup(l)}if(void 0!==e.layerDefinition.drawingInfo.labelingInfo){var n,s,u=e.layerDefinition.drawingInfo.labelingInfo,c=r(o.properties,u);if("Point"===a.feature.geometry.type)n=a.feature.geometry.coordinates.reverse(),s="point-label";else if("LineString"===a.feature.geometry.type){var p=a.feature.geometry.coordinates,f=Math.round(p.length/2);n=p[f].reverse(),s="path-label"}else if("MultiLineString"===a.feature.geometry.type){var p=a.feature.geometry.coordinates,f=Math.round(p.length/2),y=p[f],f=Math.round(y.length/2);n=y[f].reverse(),s="path-label"}else n=a.getBounds().getCenter(),s="path-label";var h=i.marker(n,{zIndexOffset:1,icon:i.divIcon({iconSize:null,className:s,html:"<div>"+c+"</div>"})});d.addLayer(h)}}});return f=i.layerGroup([f,d]),o.push({type:"FL",title:e.title||"",layer:f}),f}console.log("create ArcGISFeatureLayer (without layerDefinition.drawingInfo)");var h="1=1";void 0!==e.layerDefinition.definitionExpression&&(h=e.layerDefinition.definitionExpression);var f=i.esri.featureLayer({url:e.url,where:h,onEachFeature:function(i,r){if(void 0!==e.popupInfo){var o=t(e.popupInfo,i.properties);r.bindPopup(o)}}});return o.push({type:"FL",title:e.title||"",layer:f}),f}if("ArcGISFeatureLayer"===e.layerType){console.log("create ArcGISFeatureLayer");var f=i.esri.featureLayer({url:e.url,onEachFeature:function(i,r){if(void 0!==e.popupInfo){var o=t(e.popupInfo,i.properties);r.bindPopup(o)}},pointToLayer:function(t,r){var o=i.marker(r,{opacity:e.opacity});return o}});return o.push({type:"FL",title:e.title||"",layer:f}),f}if("ArcGISImageServiceLayer"===e.layerType){console.log("create ArcGISImageServiceLayer");var f=i.esri.imageMapLayer({url:e.url});return o.push({type:"IML",title:e.title||"",layer:f}),f}if("ArcGISMapServiceLayer"===e.layerType){var f=i.esri.dynamicMapLayer({url:e.url});return o.push({type:"DML",title:e.title||"",layer:f}),f}if("ArcGISTiledMapServiceLayer"===e.layerType){try{var f=i.esri.basemapLayer(e.title)}catch(v){var f=i.esri.tiledMapLayer({url:e.url});i.esri.request(e.url,{},function(e,i){var t=a.getSize().x-55,r='<span class="esri-attributions" style="line-height:14px; vertical-align: -3px; text-overflow:ellipsis; white-space:nowrap; overflow:hidden; display:inline-block; max-width:'+t+'px;">'+i.copyrightText+"</span>";a.attributionControl.addAttribution(r)})}return o.push({type:"TML",title:e.title||"",layer:f}),f}if("OpenStreetMap"===e.layerType){var f=i.tileLayer("http://{s}.tile.osm.org/{z}/{x}/{y}.png",{attribution:'&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors'});return o.push({type:"TL",title:e.title||e.id||"",layer:f}),f}if("WebTiledLayer"===e.layerType){var g=p(e.templateUrl),f=i.tileLayer(g,{attribution:e.copyright});return o.push({type:"TL",title:e.title||e.id||"",layer:f}),f}if(""===e.layerType)return!1;var f=i.featureGroup([]);return console.log("Unsupported Layer: ",e),f}function l(e){var t;if("esriPMS"===e.type){var r=e.url;void 0!==e.imageData&&(r="data:"+e.contentType+";base64,"+e.imageData),t=i.icon({iconUrl:r,shadowUrl:"",iconSize:[4*e.height/3,4*e.width/3],shadowSize:[0,0],iconAnchor:[4*e.height/3-16,4*e.width/3-1],shadowAnchor:[0,0],popupAnchor:[4*e.width/3/3,4*e.height/3*-1]})}return"esriSMS"===e.type&&("esriSMSCircle"===e.style?t="esriSLSNull"===e.outline.style?i.vectorIcon({svgHeight:2*(4*e.size/3/2+4*e.outline.width/3),svgWidth:2*(4*e.size/3/2+4*e.outline.width/3),type:"circle",shape:{r:4*e.size/3/2+"",cx:4*e.size/3/2+4*e.outline.width/3,cy:4*e.size/3/2+4*e.outline.width/3},style:{fill:"rgba("+e.color[0]+","+e.color[1]+","+e.color[2]+","+e.color[3]/255+")",strokeWidth:0}}):i.vectorIcon({svgHeight:2*(4*e.size/3/2+4*e.outline.width/3),svgWidth:2*(4*e.size/3/2+4*e.outline.width/3),type:"circle",shape:{r:4*e.size/3/2+"",cx:4*e.size/3/2+4*e.outline.width/3,cy:4*e.size/3/2+4*e.outline.width/3},style:{fill:"rgba("+e.color[0]+","+e.color[1]+","+e.color[2]+","+e.color[3]/255+")",stroke:"rgba("+e.outline.color[0]+","+e.outline.color[1]+","+e.outline.color[2]+","+e.outline.color[3]/255+")",strokeWidth:4*e.outline.width/3}}):"esriSMSSquare"===e.style?t="esriSLSNull"===e.outline.style?i.vectorIcon({svgHeight:4*e.size/3+4*e.outline.width/3*2+2,svgWidth:4*e.size/3+4*e.outline.width/3*2+2,type:"rect",shape:{x:"1",y:"1",width:4*e.size/3+"",height:4*e.size/3+""},style:{fill:"rgba("+e.color[0]+","+e.color[1]+","+e.color[2]+","+e.color[3]/255+")",strokeWidth:0}}):i.vectorIcon({svgHeight:4*e.size/3+4*e.outline.width/3*2+2,svgWidth:4*e.size/3+4*e.outline.width/3*2+2,type:"rect",shape:{x:"1",y:"1",width:4*e.size/3+"",height:4*e.size/3+""},style:{fill:"rgba("+e.color[0]+","+e.color[1]+","+e.color[2]+","+e.color[3]/255+")",stroke:"rgba("+e.outline.color[0]+","+e.outline.color[1]+","+e.outline.color[2]+","+e.outline.color[3]/255+")",strokeWidth:4*e.outline.width/3}}):""===e.style?"esriSLSNull"===e.outline.style:t="esriSLSNull"===e.outline.style?i.vectorIcon({svgHeight:2*(4*e.size/3+4*e.outline.width/3),svgWidth:2*(4*e.size/3+4*e.outline.width/3),type:"circle",shape:{r:4*e.size/3+"",cx:4*e.size/3+4*e.outline.width/3,cy:4*e.size/3+4*e.outline.width/3},style:{fill:"rgba("+e.color[0]+","+e.color[1]+","+e.color[2]+","+e.color[3]/255+")",strokeWidth:0}}):i.vectorIcon({svgHeight:2*(4*e.size/3+4*e.outline.width/3),svgWidth:2*(4*e.size/3+4*e.outline.width/3),type:"circle",shape:{r:4*e.size/3+"",cx:4*e.size/3+4*e.outline.width/3,cy:4*e.size/3+4*e.outline.width/3},style:{fill:"rgba("+e.color[0]+","+e.color[1]+","+e.color[2]+","+e.color[3]/255+")",stroke:"rgba("+e.outline.color[0]+","+e.outline.color[1]+","+e.outline.color[2]+","+e.outline.color[3]/255+")",strokeWidth:4*e.outline.width/3}})),t}function n(e){var i;if("esriSLSSolid"===e.style&&(i={color:"rgba("+e.color[0]+","+e.color[1]+","+e.color[2]+","+e.color[3]/255+")",weight:4*e.size/3||4*e.width/3}),"esriSFSSolid"===e.style){var t=e.color,r=e.outline.color;null===e.color&&(t=[0,0,0,0]),null===e.outline.color&&(r=[0,0,0,0]),i={fillColor:"rgb("+t[0]+","+t[1]+","+t[2]+")",fillOpacity:t[3]/255,color:"rgba("+r[0]+","+r[1]+","+r[2]+","+r[3]/255+")",weight:4*e.outline.width/3}}return i}function s(e,i,t){var r=e;return i.map(function(e){var i=t[e.field];if("sizeInfo"===e.type){var o=(i-e.minDataValue)/(e.maxDataValue-e.minDataValue),a=o*(e.maxSize-e.minSize)+e.minSize;r.size=a,null===i&&(r.size=6)}else if("colorInfo"===e.type){var l=e.stops;l.map(function(e,t){if(0===t){if(e.value>i){var o=e.color;r.color=o}}else if(t===l.length-1){if(e.value<=i){var o=e.color;r.color=o}}else if(e.value>i&&l[t-1].value<=i){var o=[],a=(i-l[t-1].value)/(e.value-l[t-1].value);r.color.map(function(i,r){o[r]=Math.round(a*(e.color[r]-l[t-1].color[r])+l[t-1].color[r])}),r.color=o}})}}),r}function u(e,i){var t={};return"simple"===e.type&&(t=n(e.symbol)),"uniqueValue"===e.type&&e.uniqueValueInfos.map(function(r){if(r.value===i[e.field1]){var o=r.symbol;void 0!==e.visualVariables&&(o=s(r.symbol,e.visualVariables,i)),t=n(o)}}),"classBreaks"===e.type&&e.classBreakInfos.map(function(r,o){var a,l=r.symbol;a=0===o?e.minValue:e.classBreakInfos[o-1].classMaxValue,e.classBreakInfos.length===o+1?r.classMaxValue>=i[e.field]&&a<=i[e.field]&&(void 0!==e.visualVariables&&(l=s(r.symbol,e.visualVariables,i)),t=n(r.symbol)):r.classMaxValue>i[e.field]&&a<=i[e.field]&&(void 0!==e.visualVariables&&(l=s(r.symbol,e.visualVariables,i)),t=n(r.symbol))}),t}function c(e,i){var t;return"simple"===e.type&&(t=l(e.symbol)),"uniqueValue"===e.type&&e.uniqueValueInfos.map(function(r){if(r.value===i[e.field1]){var o=r.symbol;void 0!==e.visualVariables&&(o=s(r.symbol,e.visualVariables,i)),t=l(o)}}),"classBreaks"===e.type&&e.classBreakInfos.map(function(r,o){var a,n=r.symbol;a=0===o?e.minValue:e.classBreakInfos[o-1].classMaxValue,e.classBreakInfos.length===o+1?r.classMaxValue>=i[e.field]&&a<=i[e.field]&&(void 0!==e.visualVariables&&(n=s(r.symbol,e.visualVariables,i)),t=l(n)):r.classMaxValue>i[e.field]&&a<=i[e.field]&&(void 0!==e.visualVariables&&(n=s(r.symbol,e.visualVariables,i)),t=l(r.symbol))}),t}function p(e){var i=e;return i=i.replace(/\{level}/g,"{z}"),i=i.replace(/\{col}/g,"{x}"),i=i.replace(/\{row}/g,"{y}")}function f(e,i){return new y(e,i)}i="default"in i?i["default"]:i;var d="0.3.0",y=i.Evented.extend({options:{map:{},token:null},initialize:function(e,t){i.setOptions(this,t),this._map=this.options.map,this._token=this.options.token,this._webmapId=e,this._loaded=!1,this._metadataLoaded=!1,this.layers=[],this.title="",this.bookmarks=[],this.portalItem={},this.VERSION=d,this._loadWebMapMetaData(e),this._loadWebMap(e)},_loadWebMapMetaData:function(e){var t=this._map,r=this,o="https://www.arcgis.com/sharing/rest/content/items/"+e;i.esri.request(o,{},function(e,i){e?console.log(e):(console.log("WebMap MetaData: ",i),r.portalItem=i,r.title=i.title,r._metadataLoaded=!0,r.fire("metadataLoad"),t.fitBounds([i.extent[0].reverse(),i.extent[1].reverse()]))})},_loadWebMap:function(e){var t=this._map,r=this.layers,a=(this._generateEsriLayer,"https://www.arcgis.com/sharing/rest/content/items/"+e+"/data");i.esri.request(a,{},function(e,a){e?console.log(e):(console.log("WebMap: ",a),a.baseMap.baseMapLayers.map(function(e){var i=o(e,r,t).addTo(t);void 0!==i&&e.visibility===!0&&i.addTo(t)}.bind(this)),a.operationalLayers.map(function(e){var i=o(e,r,t);void 0!==i&&e.visibility===!0&&i.addTo(t)}.bind(this)),void 0!==a.bookmarks&&a.bookmarks.length>0&&a.bookmarks.map(function(e){var t=i.Projection.SphericalMercator.unproject(i.point(e.extent.xmax,e.extent.ymax)),r=i.Projection.SphericalMercator.unproject(i.point(e.extent.xmin,e.extent.ymin)),o=i.latLngBounds(r,t);this.bookmarks.push({name:e.name,bounds:o})}.bind(this)),this._loaded=!0,this.fire("load"))}.bind(this))}});e.WebMap=y,e.webMap=f,e.operationalLayer=o,e.createPopupContent=t,e.createLabelText=r,Object.defineProperty(e,"__esModule",{value:!0})});
//# sourceMappingURL=esri-leaflet-webmap.js.map